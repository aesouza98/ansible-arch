---
- name: Ensure UWSM autostart block exists when DM is uwsm
  ansible.builtin.blockinfile:
    path: "/home/{{ user.username }}/.zprofile"
    marker: "# {mark} ANSIBLE_UWSM_AUTOSTART"
    block: |
      # Start Hyprland on TTY1 only
      if [ -z "$DISPLAY" ] && [ "$XDG_VTNR" = 1 ]; then
          if uwsm check may-start; then
              exec uwsm start hyprland-uwsm.desktop
          fi
      fi
    owner: "{{ user.username }}"
    group: "{{ user.group | default(user.username) }}"
    mode: "0644"
    create: true
    prepend_newline: true
  when: user.display_manager == "uwsm"
  become: true
  become_user: "{{ user.username }}"

- name: Remove UWSM autostart block if DM is not uwsm
  ansible.builtin.blockinfile:
    path: "/home/{{ user.username }}/.zprofile"
    marker: "# {mark} ANSIBLE_UWSM_AUTOSTART"
    state: absent
  when: user.display_manager != "uwsm"
  become: true
  become_user: "{{ user.username }}"
