---
- name: Disable systemd-networkd if present
  ansible.builtin.systemd_service:
    name: systemd-networkd.service
    enabled: false
    state: stopped
  ignore_errors: true
  become: true

- name: Ensure NetworkManager and iwd packages are installed
  community.general.pacman:
    name:
      - networkmanager
      - iwd
    state: present
  become: true

- name: Create NetworkManager iwd configuration directory
  ansible.builtin.file:
    path: /etc/NetworkManager/conf.d
    state: directory
    mode: "0755"
  become: true

- name: Configure NetworkManager to use iwd backend
  ansible.builtin.copy:
    dest: /etc/NetworkManager/conf.d/wifi_backend.conf
    content: |
      [device]
      wifi.backend=iwd
    mode: "0644"
  become: true

- name: Disable standalone iwd service (NetworkManager will handle it)
  ansible.builtin.systemd:
    name: iwd.service
    enabled: false
    state: stopped
  become: true

- name: Disable wpa_supplicant if installed (conflicts with iwd)
  ansible.builtin.systemd:
    name: wpa_supplicant.service
    enabled: false
    state: stopped
  ignore_errors: true
  become: true

- name: Enable and start NetworkManager
  ansible.builtin.systemd:
    name: NetworkManager.service
    enabled: true
    state: started
  become: true

# - name: Get wifi interface name
#   ansible.builtin.command: 'nmcli -t -f DEVICE,TYPE device | grep ":wifi" | cut -d: -f1 | head -n1'
#   register: base_wifi_iface_cmd
#   changed_when: false
#
# - name: Set wifi interface fact
#   ansible.builtin.set_fact:
#     base_wifi_interface: "{{ base_wifi_iface_cmd.stdout }}"
#
# - name: Connect to Wi-Fi network using NetworkManager
#   community.general.nmcli:
#     type: wifi
#     conn_name: "{{ wifi_ssid }}"
#     ifname: "{{ base_wifi_interface }}"
#     ssid: "{{ wifi_ssid }}"
#     wifi_sec:
#       key-mgmt: "wpa-psk"
#       psk: "{{ wifi_password }}"
#     autoconnect: true
#     state: present
#   become: true
#
# - name: Bring Wi-Fi connection up
#   community.general.nmcli:
#     conn_name: "{{ wifi_ssid }}"
#     state: up
#   become: true
